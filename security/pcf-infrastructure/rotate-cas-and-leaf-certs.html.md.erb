---
title: Rotating the Root CA and Leaf Certificates
owner: Ops Manager
---

This topic describes how to rotate the <%= vars.ops_manager %> root certificate authority (CA) and leaf certificates using the <%= vars.ops_manager %> API.


## <a id='overview'></a> Overview

This procedure uses the <%= vars.ops_manager %> API to rotate the <%= vars.ops_manager %> root CA and leaf certificates. When you rotate the <%= vars.ops_manager %> root CA, the <%= vars.ops_manager %> API automatically rotates the BOSH NATS CA. To rotate only leaf certificates, see one of the leaf certificate rotation topics listed in [Overview of Certificate Rotation](api-cert-rotation.html).

To prevent system downtime, this procedure includes two BOSH deploys. The first BOSH deploy applies new certificates to <%= vars.platform_name %> components. The second BOSH deploy deletes the old certificates.

<p class="note warning"><strong>Warning:</strong> You must complete these steps in the exact order specified. Otherwise, you may damage your deployment.</p>

To rotate the <%= vars.ops_manager %> root CA, configurable leaf certificates, and non-configurable leaf certificates:

1. Add a new <%= vars.ops_manager %> root CA. For more information, see [Add a New Root CA](#add-new-ca) below.

1. Activate the <%= vars.ops_manager %> root CA. For more information, see [Activate the Root CA](#activate-new-ca) below.

1. Rotate configurable leaf certificates. For more information, see [Rotate Configurable Leaf Certificates](#rotate-config-after-new-root) below.

1. Rotate non-configurable leaf certificates. For more information, see [Rotate Non-Configurable Leaf Certificates from the New Root CA](#regenerate-from-new-root) below.

1. Delete the old root CA. For more information, see [Delete the Old Root CA](#delete) below.

<p class="note warning"><strong>Warning:</strong> The Services TLS CA certificate, <code>/services/tls_ca</code>, cannot be rotated using this procedure. For information about how to rotate the Services TLS CA, see <a href="services_tls_ca_rotate.html">Rotate the Services TLS CA and Its Leaf Certificates</a>.</p>


## <a id='add-new-ca'></a> Step 1: Add a New Root CA

This section describes how to add a new root CA for <%= vars.ops_manager %>. The new root CA can be a <%= vars.platform_name %>-generated CA or your own custom CA.

This procedure also automatically regenerates the BOSH NATS CA.

<p class="note warning"><strong>Warning:</strong> The <%= vars.ops_manager %> API also excludes from rotation the CAs for certain versions of the MySQL for <%= vars.platform_name %>, Redis for <%= vars.platform_name %>, Pivotal RabbitMQ, and Pivotal Cloud Cache tiles. For information about rotating these CAs, see the documentation for each tile.</p>

To add a new root CA for <%= vars.ops_manager %> and regenerate the BOSH NATS CA:

1. If you have not already done so, follow the procedure in [Using <%= vars.ops_manager %> API](../../install/ops-man-api.html) to target and authenticate with the <%= vars.ops_manager %> UAA server. Record your <%= vars.ops_manager %> access token, and use it for `UAA-ACCESS-TOKEN` in the following steps.
  <p class="note"><strong>Note:</strong> When you record your <%= vars.ops_manager %> access token, remove any newline characters such as <code>\n</code>.</p>

1. Use <%= vars.ops_manager %> to generate a new CA, or add your own custom CA:
  <p class ="note"><strong>Note:</strong> Elliptic Curve Digital Signature Algorithm (ECDSA) certificates are not supported in <%= vars.platform_name %>.</p>
  * **To use your own custom CA:** Call the <%= vars.ops_manager %> API `certificate_authorities` endpoint by running:

        ```
        curl "https://OPS-MANAGER-FQDN/api/v0/certificate_authorities" \
            -X POST \
            -H "Authorization: Bearer UAA-ACCESS-TOKEN" \
            -H "Content-Type: application/json" \
            -d '{"cert_pem": "-----BEGIN CERTIFICATE-----\CUSTOM-CERTIFICATE", "private_key_pem": "-----BEGIN RSA PRIVATE KEY-----\RSA-KEY"}'
        ```
        Where:
        * `OPS-MANAGER-FQDN` is the fully-qualified domain name (FQDN) of your <%= vars.ops_manager %> deployment.
        * `CUSTOM-CERTIFICATE` is your custom CA.
        * `RSA-KEY` is your RSA key.
        * `UAA-ACCESS-TOKEN` is your UAA access token.
        <br>
        <br>
        If the command succeeds, the API returns a response that includes the new CA. For example:
        <pre class="terminal">
        HTTP/1.1 200 OK
        {
          "certificate_authorities": [
            {
              "guid": "f7bc18f34f2a7a9403c3",
              "issuer": "CUSTOM-CERTIFICATE",
              "created_on": "2017-01-09",
              "expires_on": "2021-01-09",
              "active": true,
              "cert_pem": "-----BEGIN CERTIFICATE-----\nMIIC+zCCAeOgAwIBAgI....etc"
            }
          ]
        }
        </pre>
  * **To use a <%= vars.platform_name %>-generated CA:** Call the <%= vars.ops_manager %> API `generate` endpoint by running:

        ```
        curl "https://OPS-MANAGER-FQDN/api/v0/certificate_authorities/generate" \
              -X POST \
              -H "Authorization: Bearer UAA-ACCESS-TOKEN" \
              -H "Content-Type: application/json" \
              -d '{}'
        ```
        Where:
        * `OPS-MANAGER-FQDN` is the FQDN of your <%= vars.ops_manager %> deployment.
        * `UAA-ACCESS-TOKEN` is your UAA access token.
        <br>
        <br>
        If the command succeeds, the API returns a response that includes the new CA. For example:
        <pre class="terminal">
        HTTP/1.1 200 OK
        {
         "guid": "f7bc18f34f2a7a9403c3",
         "issuer": "<%= vars.company_name %>",
         "created_on": "2017-01-19",
         "expires_on": "2021-01-19",
         "active": false,
         "cert_pem": "-----BEGIN EXAMPLE CERTIFICATE-----
         MIIC+zCCAeOgAwIBAgIBADANBgkqhkiG9w0BAQsFADAfMQswCQYDVQQGEwJVUzEQ
         EXAMPLEoCgwHUGl2b3RhbDAeFw0xNDarthgyMTQyMjVaFw0yMTAxMTkyMTQyMjVa
         EXAMPLEoBgNVBAYTAlVTMRAwDgYDVVaderdQaXZvdGFsMIIBIjANBgkqhkiG9w0B
         EXAMPLEoAQ8AMIIBCgKCAQEAyV4OhPIIZTEym9OcdcNVip9Ev0ijPPLo9WPLUMzT
         EXAMPLEo/TgD+DP09mwVXfqwBlJmoj9DqRED1x/6bc0Ki/BAFo/P4MmOKm3QnDCt
         EXAMPLEooqgA++2HYrNTKWJ5fsXmERs8lK9AXXT7RKXhktyWWU3oNGf7zo0e3YKp
         EXAMPLEoh1NwIbNcGT1AurIDsxyOZy1HVzBLTisMyDogJmSCLsOw3qUDQjatjXKw
         EXAMPLEojG3nv2hvD4/aTOiHuKM3+AGbnaS2MdIOvFOh/7Y79tUp89csK0gs6uOd
         EXAMPLEohe4DcKw5CzUTfHKNXgHyeoVOBPcVQTp4lJp1iQIDAQABo0IwQDAdBgNV
         EXAMPLEoyH4y7VEuImLStXM0CKR8uVqxX/gwDwYDVR0TAQH/BAUwAwEB/zAOBgNV
         EXAMPLEoBAMCAQYwDQYJKoZIhvcNAQELBQADggEBALmHOPxdyBGnuR0HgR9V4TwJ
         EXAMPLEoGLKVT7am5z6G2Oq5cwACFHWAFfrPG4W9Jm577QtewiY/Rad/PbkY0YSY
         EXAMPLEokrfNjxjxI0H2sr7qLBFjJ0wBZHhVmDsO6A9PkfAPu4eJvqRMuL/xGmSQ
         EXAMPLEoCynMNz7FgHyFbd9D9X5YW8fWGSeVBPPikcONdRvjw9aEeAtbGEh8eZCP
         EXAMPLEob33RuR+CTNqThXY9k8d7/7ba4KVdd4gP8ynFgwvnDQOjcJZ6Go5QY5HA
         EXAMPLEoPFW8pAYcvWrXKR0rE8fL5o9qgTyjmO+5yyyvWIYrKPqqIUIvMCdNr84=
           -----END EXAMPLE CERTIFICATE-----"
        }
        </pre>

1. Confirm that the new CA is added by listing all the CAs for <%= vars.ops_manager %>. Run:

    ```
    curl "https://OPS-MANAGER-FQDN/api/v0/certificate_authorities" \
          -X GET \
          -H "Authorization: Bearer UAA-ACCESS-TOKEN"
    ```
    Where:
    * `OPS-MANAGER-FQDN` is the FQDN of your <%= vars.ops_manager %> deployment.
    * `UAA-ACCESS-TOKEN` is your UAA access token.
    <br>
    <br>
    The API call returns the GUID of the newly added CA. For example:
    <pre class="terminal">
    HTTP/1.1 200 OK
    {
      "certificate_authorities": [
        {
          "guid": "f7bc18f34f2a7a9403c3",
          "issuer": "<%= vars.company_name %>",
          "created_on": "2017-01-09",
          "expires_on": "2021-01-09",
          "active": true,
          "cert_pem": "-----BEGIN CERTIFICATE-----\nMIIC+zCCAeOgAwIBAgI....etc"
        }
        {
          "guid": "a8ee01e33e3e3e3303e3",
          "issuer": "<%= vars.company_name %>",
          "created_on": "2017-04-09",
          "expires_on": "2021-04-09",
          "active": false,
          "cert_pem": "-----BEGIN CERTIFICATE-----\nzBBBC+eAAAe1gAwAAAeZ....etc"
        }
      ]
    }
    </pre>

1. Identify the newly added CA, which has `active` set to `false`. Record its GUID.

1. Navigate to `https://OPS-MANAGER-FQDN` in a browser, where `OPS-MANAGER-FQDN` is the FQDN of your <%= vars.ops_manager %> deployment.

1. Log in to the <%= vars.ops_manager %> Installation Dashboard.

1. Click the **BOSH Director** tile.

1. Select **Director Config**.

1. Enable the **Recreate All VMs** checkbox. This propagates the new root CA to all VMs deployed by the BOSH Director to prevent downtime.

1. Return to the <%= vars.ops_manager %> Installation Dashboard.

1. If you have service tiles installed, for each service tile:
    <p class='note'><strong>Note:</strong> The names of the <strong>Upgrade All Service Instances</strong> and <strong>Recreate All Service Instances</strong> errands may be slightly different between services.</p>
    1. Click the tile.
    1. Click the **Errands** tab.
    1. Enable the **Upgrade All Service Instances** errand. Running this errand is necessary to push CredHub certificate updates to each service instance.
    1. If the service tile has the **Recreate All Service Instances** errand:
        1. Enable the **Recreate All Service Instances** errand.
        1. Click **Review Pending Changes**.
        1. Click **Apply Changes**.
    1. If the service tile does not have the **Recreate All Service Instances** errand:
        1. Click **Review Pending Changes**.
        1. Click **Apply Changes**.
        1. When the deploy finishes, manually push the BOSH NATS CA to each service instance. For each service instance, run:

            ```
            bosh -d SERVICE-INSTANCE-DEPLOYMENT recreate
            ```
            Where `SERVICE-INSTANCE-DEPLOYMENT` is the BOSH deployment name for the service instance.

1. If you do not have any service tiles installed:
    1. Click **Review Pending Changes**.
    1. Click **Apply Changes**.

1. When the deploy finishes and you have completed all necessary tasks to update service instances, continue to the next section, [Activate the Root CA](#activate-new-ca).


## <a id='activate-new-ca'></a> Step 2: Activate the Root CA

To activate the new root CA:

1. Call the <%= vars.ops_manager %> API `activate` endpoint by running:

    ```
    curl "https://OPS-MANAGER-FQDN/api/v0/certificate_authorities/CERTIFICATE-GUID/activate" \
      -X POST \
      -H "Authorization: Bearer UAA-ACCESS-TOKEN" \
      -H "Content-Type: application/json" \
      -d '{}'
    ```
    Where:
    * `OPS-MANAGER-FQDN` is the FQDN of your <%= vars.ops_manager %> deployment.
    * `CERTIFICATE-GUID` is the GUID of your root CA that you retrieved in the previous section.
    * `UAA-ACCESS-TOKEN` is your UAA access token.
    <br>
    <br>
    The API returns a successful response:
    <pre class="terminal">HTTP/1.1 200 OK</pre>

1. List your CAs again to confirm that the new <%= vars.ops_manager %> root CA is active. Run:

    ```
    curl "https://OPS-MANAGER-FQDN/api/v0/certificate_authorities" \
          -X GET \
          -H "Authorization: Bearer UAA-ACCESS-TOKEN"
    ```
    Where:
    * `OPS-MANAGER-FQDN` is the FQDN of your <%= vars.ops_manager %> deployment.
    * `UAA-ACCESS-TOKEN` is your UAA access token.

1. Examine the response to ensure that your new root CA has the `active` property set to `true`.


## <a id='rotate-config-after-new-root'></a> Step 3: Rotate Configurable Leaf Certificates

Any configurable leaf certificates generated from the <%= vars.ops_manager %> root CA must be rotated. These are the leaf certificates that you generated using the **Generate RSA Certificate** button in the <%= vars.ops_manager %> UI. For example, see [Providing a Certificate for Your TLS Termination Point](https://docs.pivotal.io/application-service/<%= product_info['local_product_version'].to_s.sub('.','-') %>/operating/security_config.html) in the <%= vars.app_runtime_abbr %> documentation.

To regenerate and rotate each configurable leaf certificate that expires soon:

1. Find the text field where the leaf certificate is configured within the <%= vars.ops_manager %> UI. You might need to look through multiple configuration panes to identify the location of the certificate configuration text field. Use the following fields to identify the location of the certificate configuration text field:
    * The `product_guid` field in the <%= vars.ops_manager %> API output can help identify the tile in which the certificate is configured. For example, the prefix `p-bosh-` refers to the BOSH Director tile, and the prefix `cf-` refers to the <%= vars.app_runtime_abbr %> tile.
    * The `property_reference` field in the <%= vars.ops_manager %> API output can help identify the configuration pane in which the certificate is configured. For example, the `uaa.service_provider_key_credentials` property is configured in the **UAA** pane of the <%= vars.app_runtime_abbr %> tile.

1. Copy a new value for the leaf certificate into the text field or generate a new leaf certificate using the **Generate RSA Certificate** button.

1. Click **Save** at the bottom of each pane in which you added new leaf certificates.


## <a id='regenerate-from-new-root'></a> Step 4: Rotate Non-Configurable Leaf Certificates from the New Root CA

After activating the new <%= vars.ops_manager %> root CA, you must rotate non-configurable leaf certificates from the new root CA.

To rotate non-configurable leaf certificates:

1. Call the <%= vars.ops_manager %> API `regenerate` endpoint by running:

    ```
    curl "https://OPS-MANAGER-FQDN/api/v0/certificate_authorities/active/regenerate" \
          -X POST \
          -H "Authorization: Bearer UAA-ACCESS-TOKEN" \
          -H "Content-Type: application/json" \
          -d '{}'
    ```
    Where:
    * `OPS-MANAGER-FQDN` is the FQDN of your <%= vars.ops_manager %> deployment.
    * `UAA-ACCESS-TOKEN` is your UAA access token.
    <br>
    <br>
    The API returns a successful response:
    <pre class="terminal">HTTP/1.1 200 OK</pre>

1. Navigate to the <%= vars.ops_manager %> Installation Dashboard.

1. Click the **BOSH Director** tile.

1. Select **Director Config**.

1. Enable the **Recreate All VMs** checkbox. This propagates the new CAs to all VMs deployed by the BOSH Director to prevent downtime.

1. Return to the <%= vars.ops_manager %> Installation Dashboard.

1. If you have service tiles installed, for each service tile:
    <p class='note'><strong>Note:</strong> The names of the <strong>Upgrade All Service Instances</strong> and <strong>Recreate All Service Instances</strong> errands may be slightly different between services.</p>
    1. Click the tile.
    1. Click the **Errands** tab.
    1. Enable the **Upgrade All Service Instances** errand. Running this errand is necessary to push CredHub certificate updates to each service instance.
    1. If the service tile has the **Recreate All Service Instances** errand:
        1. Enable the **Recreate All Service Instances** errand.
        1. Click **Review Pending Changes**.
        1. Click **Apply Changes**.
    1. If the service tile does not have the **Recreate All Service Instances** errand:
        1. Click **Review Pending Changes**.
        1. Click **Apply Changes**.
        1. When the deploy finishes, manually push the BOSH NATS CA to each service instance. For each service instance, run:

            ```
            bosh -d SERVICE-INSTANCE-DEPLOYMENT recreate
            ```
            Where `SERVICE-INSTANCE-DEPLOYMENT` is the BOSH deployment name for the service instance.

1. If you do not have any service tiles installed:
    1. Click **Review Pending Changes**.
    1. Click **Apply Changes**.

1. When the deploy finishes and you have completed all necessary tasks to update service instances, continue to the next section, [Delete the Old Root CA](#delete).


## <a id='delete'></a> Step 5: Delete the Old Root CA

After activating new CAs and rotating leaf certificates from the new CAs, you should delete the old <%= vars.ops_manager %> root CA from your foundation.

If your old root CA or leaf certificates have been compromised, you must delete the old root CA immediately. Otherwise, the old root CA and its leaf certificates may still be trusted, which compromises your foundation's security. If your old root CA or leaf certificates have not been compromised, <%= vars.company_name %> recommends that you delete the old root CA as soon as possible, but you can also delete it at a later time, such as in conjunction with another deploy.

<p class="note warning"><strong>Warning:</strong> Before you delete the old CA, ensure that you reviewed the <strong>Review Pending Changes</strong> page and clicked <strong>Apply Changes</strong> as part of <a href="#regenerate-from-new-root">Rotate Non-Configurable Leaf Certificates from the New Root CA</a> above.</p>

To delete the old <%= vars.ops_manager %> root CA:

1. List your CAs to retrieve the GUID of the old, inactive <%= vars.ops_manager %> root CA. Run:

    ```
    curl "https://OPS-MANAGER-FQDN/api/v0/certificate_authorities" \
          -X GET \
          -H "Authorization: Bearer UAA-ACCESS-TOKEN"
    ```
    Where:
    * `OPS-MANAGER-FQDN` is the FQDN of your <%= vars.ops_manager %> deployment.
    * `UAA-ACCESS-TOKEN` is your UAA access token.

1. Delete the old <%= vars.ops_manager %> root CA by running:

    ```
    curl "https://OPS-MANAGER-FQDN/api/v0/certificate_authorities/OLD-CERTIFICATE-GUID" \
          -X DELETE \
          -H "Authorization: Bearer UAA-ACCESS-TOKEN"
    ```
    Where:
    * `OPS-MANAGER-FQDN` is the FQDN of your <%= vars.ops_manager %> deployment.
    * `OLD-CERTIFICATE-GUID` is the GUID of the old <%= vars.ops_manager %> root CA.
    * `UAA-ACCESS-TOKEN` is your UAA access token.
    <br>
    <br>
    The API returns a successful response:
    <pre class="terminal">HTTP/1.1 200 OK</pre>

1. Navigate to the <%= vars.ops_manager %> Installation Dashboard.

1. Click the **BOSH Director** tile.

1. Select **Director Config**.

1. Enable the **Recreate All VMs** checkbox.

1. Return to the <%= vars.ops_manager %> Installation Dashboard.

1. If you have service tiles installed, for each service tile:
    <p class='note'><strong>Note:</strong> The names of the <strong>Upgrade All Service Instances</strong> and <strong>Recreate All Service Instances</strong> errands may be slightly different between services.</p>
    1. Click the tile.
    1. Click the **Errands** tab.
    1. Enable the **Upgrade All Service Instances** errand. Running this errand is necessary to push CredHub certificate updates to each service instance.
    1. If the service tile has the **Recreate All Service Instances** errand:
        1. Enable the **Recreate All Service Instances** errand. Running this errand pushes BOSH agent certificate updates to service instances.
        1. Click **Review Pending Changes**.
        1. Click **Apply Changes**.
    1. If the service tile does not have the **Recreate All Service Instances** errand:
        1. Click **Review Pending Changes**.
        1. Click **Apply Changes**.
        1. When the deploy finishes, manually push BOSH agent certificate updates to each service instance. For each service instance, run:

            ```
            bosh -d SERVICE-INSTANCE-DEPLOYMENT recreate
            ```
            Where `SERVICE-INSTANCE-DEPLOYMENT` is the BOSH deployment name for the service instance.

1. If you do not have any service tiles installed:
    1. Click **Review Pending Changes**.
    1. Click **Apply Changes**.
